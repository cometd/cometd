package org.cometd.bwtp.client;

import java.net.InetAddress;
import java.net.InetSocketAddress;
import java.util.concurrent.CountDownLatch;
import java.util.concurrent.ExecutorService;
import java.util.concurrent.Executors;
import java.util.concurrent.TimeUnit;

import org.cometd.bwtp.BWTPActionType;
import org.cometd.bwtp.BWTPChannel;
import org.cometd.bwtp.BWTPConnection;
import org.cometd.bwtp.BWTPHeaderFrame;
import org.cometd.bwtp.BWTPListener;
import org.cometd.bwtp.server.BWTPServer;
import org.cometd.wharf.ServerConnector;
import org.cometd.wharf.async.StandardAsyncServerConnector;
import org.junit.After;
import org.junit.Before;
import org.junit.Test;

import static org.junit.Assert.assertNotNull;
import static org.junit.Assert.assertTrue;

/**
 * @version $Revision$ $Date$
 */
public class BWTPConnectionOpenTest
{
    private ExecutorService threadPool;
    private InetSocketAddress address;
    private ServerConnector serverConnector;

    @Before
    public void init() throws Exception
    {
        threadPool = Executors.newCachedThreadPool();
        address = new InetSocketAddress(InetAddress.getByName(null), 0);
        serverConnector = new StandardAsyncServerConnector(address, new BWTPServer(), threadPool);
        address = new InetSocketAddress(address.getAddress(), serverConnector.getPort());
    }

    @After
    public void destroy()
    {
        serverConnector.close();
        threadPool.shutdown();
    }

    @Test
    public void testOpen() throws Exception
    {
        BWTPClient client = new BWTPClient(threadPool);
        BWTPConnection connection = client.connect(address, "/", null);
        BWTPChannel channel = connection.open("", null);
        assertNotNull(channel);
        connection.close(null);
    }

    @Test
    public void testOpenNotification() throws Exception
    {
        BWTPClient client = new BWTPClient(threadPool);
        BWTPConnection connection = client.connect(address, "/", null);
        final CountDownLatch latch = new CountDownLatch(1);
        connection.addListener(new BWTPListener.Adapter()
        {
            @Override
            public void onHeader(BWTPChannel channel, BWTPHeaderFrame frame)
            {
                if (frame.getAction() == BWTPActionType.OPENED)
                    latch.countDown();
            }
        });
        connection.open("", null);
        assertTrue(latch.await(1, TimeUnit.SECONDS));
        connection.close(null);
    }
}
