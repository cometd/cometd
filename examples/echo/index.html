<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN"
	"http://www.w3.org/TR/html4/strict.dtd">
<html>
	<head>
		<title>Comet echo RPC</title>

		<link rel="stylesheet" type="text/css" href="chat/chat.css"></link>

		<script type="text/javascript">
			var djConfig = { isDebug: false };
		</script>
		<script type="text/javascript" src="../../dojo/dojo.js"></script>
		<script type="text/javascript" src="behaviour.js"></script>
		<script language="JavaScript" type="text/javascript">

	function $() {
	  return document.getElementById(arguments[0]);
	}


        var EvUtil =
        {
          getKeyCode : function(ev)
          {
            var keyc;
            if (window.event)
              keyc=window.event.keyCode;
            else
              keyc=ev.keyCode;
            return keyc;
          }
        };

        var echoBehaviours = 
        { 
            '#phrase' : function(element)
            {
              element.setAttribute("autocomplete","OFF");
              element.onkeyup = function(ev)
              {   
                  var keyc=EvUtil.getKeyCode(ev);
                  if (keyc==13 || keyc==10)
                  {
                    echoRpc($('phrase').value);
                    $('phrase').value='';
	                return false;
	              }
                  return true;
              }
            },
  
            '#sendB' : function(element)
            {
              element.onclick = function(event)
              {
                echoRpc($('phrase').value);
                $('phrase').value='';
                return false;
              }
            }
          };



			function setUp()
			{
				dojo.require("dojo.io.cometd");
				dojo.require("dojo.event.*");

				dojo.event.connect(cometd, "finishInit", 
					function(type, data, evt, request){
						cometd.subscribe(
							"/rpc/echo/"+cometd.clientId,
							true, 
							"echoRpcReturn"
						);
					}
				);
				
				cometd.init({}, "/cometd");
				
				
				Behaviour.register(echoBehaviours); 
				
				
			}

			function echoRpc(msg)
			{
       		    cometd.publish("/rpc/echo", { msg: msg });
			}
			
			function echoRpcReturn(msg)
			{
				$("responses").innerHTML+=msg.timestamp+" "+msg.channel+": "+msg.data.msg+"\n";
			}

			dojo.addOnLoad(setUp());
		</script>
	</head>
	<body>
	
	<h1>Echo test</h1>
	<p>Echo data to ONLY this client using RPC style messaging over cometd. Requires a server side component at /rpc/echo
	which echos responses to /rpc/echo/<i>clientId</i> (currently the jetty java
	demo provides such a server side).
	</p>
    <div>Echo:&nbsp;<input id="phrase" type="text"></input> <input id="sendB" class="button" type="submit" name="join" value="Send"/>
    </div>
    <pre id="responses"></pre>
	</body>
</html>
